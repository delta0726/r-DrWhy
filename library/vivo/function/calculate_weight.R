# Title     : calculate_weight
# Objective : TODO
# Created by: Owner
# Created on: 2020/06/21



# ＜ポイント＞
# -  Ceteris Paribusプロファイルからの変数分割に基づいて、生データの経験密度を計算します。



# ＜構文＞
# calculate_weight(profiles, data, variable_split)


# profiles
# data.frame generated by ingredients::ceteris_paribus()


# data
# data.frame with raw data to model



library(tidyverse)
library(DALEX)
library(vivo)
library(randomForest)
library(ingredients)


data(apartments)


# データロード
data(apartments)


# データ確認
apartments %>% as_tibble()
apartments %>% glimpse()






# モデル構築
apartments_rf_model <-
  randomForest(m2.price ~ construction.year + surface + floor + no.rooms,
               data = apartments)


# モデル解釈(DALEX)
explainer_rf <-
  apartments_rf_model %>%
    explain(data = apartmentsTest[,2:5], y = apartmentsTest$m2.price)



#%% ウエイト計算 ----------------------------------------------

# 新しいレコード
new_apartment <- data.frame(construction.year = 1998, surface = 88, floor = 2L, no.rooms = 3)
new_apartment %>% print()


# 新しいレコードのプロファイル
# --- ceteris_paribus()
profiles <- explainer_rf %>% ceteris_paribus(new_apartment)
profiles %>% print()



#%% ウエイト計算 ----------------------------------------------

# データ分割
split <-
  apartments %>%
    calculate_variable_split(variables = colnames(apartments),
                             grid_points = 101)


# ceteris_paribus()によって生成されたウエイトを計算
profiles %>%
  calculate_weight(data = apartments[, 2:5],
                   variable_split = split)
